<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GitHub Contributions Dashboard</title>
    <meta
      name="description"
      content="Visualize your GitHub contribution activity with beautiful charts, heatmaps, and analytics"
    />
    <meta name="theme-color" content="#10b981" />
    <link rel="manifest" href="manifest.json" />
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="icons/icon-192.png"
    />
    <link rel="apple-touch-icon" href="icons/icon-192.png" />
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"
    ></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
      const accentColors = {
        emerald: {
          400: "#34d399",
          500: "#10b981",
          600: "#059669",
          700: "#047857",
          900: "#064e3b",
        },
        green: {
          400: "#4ade80",
          500: "#22c55e",
          600: "#16a34a",
          700: "#15803d",
          900: "#14532d",
        },
        teal: {
          400: "#2dd4bf",
          500: "#14b8a6",
          600: "#0d9488",
          700: "#0f766e",
          900: "#134e4a",
        },
        cyan: {
          400: "#22d3ee",
          500: "#06b6d4",
          600: "#0891b2",
          700: "#0e7490",
          900: "#164e63",
        },
        sky: {
          400: "#38bdf8",
          500: "#0ea5e9",
          600: "#0284c7",
          700: "#0369a1",
          900: "#0c4a6e",
        },
        blue: {
          400: "#60a5fa",
          500: "#3b82f6",
          600: "#2563eb",
          700: "#1d4ed8",
          900: "#1e3a8a",
        },
        violet: {
          400: "#a78bfa",
          500: "#8b5cf6",
          600: "#7c3aed",
          700: "#6d28d9",
          900: "#4c1d95",
        },
        purple: {
          400: "#c084fc",
          500: "#a855f7",
          600: "#9333ea",
          700: "#7e22ce",
          900: "#581c87",
        },
        fuchsia: {
          400: "#e879f9",
          500: "#d946ef",
          600: "#c026d3",
          700: "#a21caf",
          900: "#701a75",
        },
        pink: {
          400: "#f472b6",
          500: "#ec4899",
          600: "#db2777",
          700: "#be185d",
          900: "#831843",
        },
        rose: {
          400: "#fb7185",
          500: "#f43f5e",
          600: "#e11d48",
          700: "#be123c",
          900: "#881337",
        },
        orange: {
          400: "#fb923c",
          500: "#f97316",
          600: "#ea580c",
          700: "#c2410c",
          900: "#7c2d12",
        },
        amber: {
          400: "#fbbf24",
          500: "#f59e0b",
          600: "#d97706",
          700: "#b45309",
          900: "#78350f",
        },
        yellow: {
          400: "#facc15",
          500: "#eab308",
          600: "#ca8a04",
          700: "#a16207",
          900: "#713f12",
        },
      };

      // Load saved accent or default to emerald
      const savedSettings = JSON.parse(
        localStorage.getItem("github-dashboard") || "{}",
      );
      const currentAccent =
        accentColors[savedSettings.accentColor] || accentColors.emerald;

      tailwind.config = {
        theme: {
          extend: {
            colors: {
              zinc: {
                850: "#1f1f23",
                950: "#09090b",
              },
              accent: currentAccent,
            },
          },
        },
      };
      // Inject CSS variables for accent colors
      const style = document.createElement("style");
      style.textContent = `
            :root {
                --accent-400: ${currentAccent[400]};
                --accent-500: ${currentAccent[500]};
                --accent-600: ${currentAccent[600]};
                --accent-700: ${currentAccent[700]};
                --accent-900: ${currentAccent[900]};
            }
        `;
      document.head.appendChild(style);
    </script>
    <style>
      [x-cloak] {
        display: none !important;
      }

      /* Flatpickr customization */
      .flatpickr-calendar {
        background: #18181b !important;
        border: 1px solid #3f3f46 !important;
        box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.5) !important;
      }
      .flatpickr-day {
        color: #e4e4e7 !important;
      }
      .flatpickr-day:hover {
        background: #3f3f46 !important;
        border-color: #3f3f46 !important;
      }
      .flatpickr-day.selected {
        background: var(--accent-500) !important;
        border-color: var(--accent-500) !important;
      }
      .flatpickr-day.inRange {
        background: var(--accent-900) !important;
        border-color: var(--accent-900) !important;
        box-shadow:
          -5px 0 0 var(--accent-900),
          5px 0 0 var(--accent-900) !important;
      }
      .flatpickr-months .flatpickr-month {
        background: #18181b !important;
        color: #e4e4e7 !important;
      }
      .flatpickr-current-month .flatpickr-monthDropdown-months {
        background: #18181b !important;
      }
      .flatpickr-weekdays {
        background: #18181b !important;
      }
      span.flatpickr-weekday {
        color: #71717a !important;
        background: #18181b !important;
      }
      .flatpickr-day.flatpickr-disabled {
        color: #52525b !important;
      }
      .numInputWrapper:hover {
        background: #3f3f46 !important;
      }
      .flatpickr-current-month input.cur-year {
        color: #e4e4e7 !important;
      }
      .flatpickr-months .flatpickr-prev-month,
      .flatpickr-months .flatpickr-next-month {
        color: #e4e4e7 !important;
        fill: #e4e4e7 !important;
      }
      .flatpickr-months .flatpickr-prev-month:hover,
      .flatpickr-months .flatpickr-next-month:hover {
        color: var(--accent-500) !important;
      }
      .flatpickr-months .flatpickr-prev-month:hover svg,
      .flatpickr-months .flatpickr-next-month:hover svg {
        fill: var(--accent-500) !important;
      }

      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #18181b;
      }
      ::-webkit-scrollbar-thumb {
        background: #3f3f46;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #52525b;
      }

      /* Chart tooltip */
      .chart-tooltip {
        position: fixed;
        pointer-events: none;
        background: #27272a;
        border: 1px solid #3f3f46;
        border-radius: 8px;
        padding: 8px 12px;
        box-shadow: 0 10px 25px -5px rgb(0 0 0 / 0.3);
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.15s;
      }
      .chart-tooltip.visible {
        opacity: 1;
      }
      .chart-tooltip-count {
        font-size: 18px;
        font-weight: 600;
        color: var(--accent-500);
      }
      .chart-tooltip-label {
        font-size: 12px;
        color: #a1a1aa;
        margin-top: 2px;
      }
    </style>
  </head>
  <body class="bg-zinc-950 text-zinc-100 min-h-screen antialiased">
    <!-- Chart Tooltip -->
    <div id="chartTooltip" class="chart-tooltip">
      <div class="chart-tooltip-count"></div>
      <div class="chart-tooltip-label"></div>
    </div>

    <div
      x-data="dashboard()"
      x-init="init()"
      class="max-w-[1600px] mx-auto p-4 sm:p-6 lg:p-8"
    >
      <!-- Header -->
      <header
        class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6"
      >
        <div class="flex items-center gap-3">
          <div class="p-2 bg-zinc-900 rounded-lg border border-zinc-800">
            <i data-lucide="git-branch" class="w-6 h-6 text-accent-500"></i>
          </div>
          <h1 class="text-xl font-semibold text-zinc-100">
            GitHub Contributions
          </h1>
        </div>
        <div class="flex items-center gap-3">
          <a
            x-show="username && avatarUrl"
            :href="'https://github.com/' + username"
            target="_blank"
            rel="noopener noreferrer"
            :title="'@' + username"
            class="block"
          >
            <img
              :src="avatarUrl"
              :alt="username"
              class="w-8 h-8 rounded-full border border-zinc-700 hover:border-zinc-500 transition-colors"
            />
          </a>
          <button
            @click="showSettings = true"
            class="inline-flex items-center gap-2 px-4 py-2 text-sm bg-zinc-900 hover:bg-zinc-800 rounded-lg border border-zinc-800 transition-colors"
          >
            <i data-lucide="settings" class="w-4 h-4"></i>
            Settings
          </button>
        </div>
      </header>

      <!-- Date Range Selector -->
      <div
        x-show="data || (!loading && username)"
        class="flex flex-wrap items-center gap-3 mb-6 p-4 bg-zinc-900 rounded-xl border border-zinc-800"
      >
        <div class="flex items-center gap-2 text-sm text-zinc-400">
          <i data-lucide="calendar" class="w-4 h-4"></i>
          <span>Period:</span>
        </div>

        <!-- Preset Buttons -->
        <div class="flex flex-wrap gap-2">
          <template x-for="preset in datePresets" :key="preset.value">
            <button
              @click="selectPreset(preset.value)"
              :class="selectedPreset === preset.value
                            ? 'bg-accent-600 text-white border-accent-600'
                            : 'bg-zinc-800 text-zinc-300 border-zinc-700 hover:bg-zinc-700'"
              class="px-3 py-1.5 text-sm rounded-lg border transition-colors"
              x-text="preset.label"
            ></button>
          </template>
        </div>

        <!-- Custom Date Range -->
        <div class="flex items-center gap-2 ml-auto">
          <div class="relative">
            <input
              type="text"
              x-ref="dateFromInput"
              placeholder="From"
              readonly
              class="w-32 px-3 py-1.5 text-sm bg-zinc-800 border border-zinc-700 rounded-lg focus:outline-none focus:border-accent-600 cursor-pointer"
            />
          </div>
          <span class="text-zinc-600">â†’</span>
          <div class="relative">
            <input
              type="text"
              x-ref="dateToInput"
              placeholder="To"
              readonly
              class="w-32 px-3 py-1.5 text-sm bg-zinc-800 border border-zinc-700 rounded-lg focus:outline-none focus:border-accent-600 cursor-pointer"
            />
          </div>
          <button
            @click="applyCustomRange()"
            x-show="customDateFrom && customDateTo"
            class="px-3 py-1.5 text-sm bg-accent-600 hover:bg-accent-500 text-white rounded-lg transition-colors"
          >
            Apply
          </button>
        </div>
      </div>

      <!-- Settings Modal -->
      <div
        x-show="showSettings"
        x-cloak
        class="fixed inset-0 z-50 flex items-center justify-center p-4"
      >
        <div
          class="absolute inset-0 bg-black/70 backdrop-blur-sm"
          @click="showSettings = false"
        ></div>
        <div
          class="relative bg-zinc-900 border border-zinc-800 rounded-2xl p-6 w-full max-w-md shadow-2xl"
        >
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-lg font-semibold">Settings</h2>
            <button
              @click="showSettings = false"
              class="p-1 hover:bg-zinc-800 rounded-lg transition-colors"
            >
              <i data-lucide="x" class="w-5 h-5 text-zinc-400"></i>
            </button>
          </div>

          <div class="space-y-5">
            <div>
              <label class="flex items-center gap-2 text-sm text-zinc-400 mb-2">
                <i data-lucide="user" class="w-4 h-4"></i>
                GitHub Username
              </label>
              <input
                type="text"
                x-model="settingsForm.username"
                placeholder="octocat"
                class="w-full px-4 py-2.5 bg-zinc-800 border border-zinc-700 rounded-xl focus:outline-none focus:border-accent-600 focus:ring-1 focus:ring-accent-600 transition-colors"
              />
            </div>

            <div>
              <label class="flex items-center gap-2 text-sm text-zinc-400 mb-2">
                <i data-lucide="key" class="w-4 h-4"></i>
                Personal Access Token
              </label>
              <input
                type="password"
                x-model="settingsForm.token"
                placeholder="ghp_xxxxxxxxxxxx"
                class="w-full px-4 py-2.5 bg-zinc-800 border border-zinc-700 rounded-xl focus:outline-none focus:border-accent-600 focus:ring-1 focus:ring-accent-600 transition-colors"
              />
              <p class="flex items-center gap-1 text-xs text-zinc-500 mt-2">
                <i data-lucide="info" class="w-3 h-3"></i>
                Requires
                <code class="bg-zinc-800 px-1.5 py-0.5 rounded">repo</code> and
                <code class="bg-zinc-800 px-1.5 py-0.5 rounded">read:user</code>
                scopes
              </p>
              <div
                class="flex items-start gap-2 mt-3 p-3 bg-emerald-950/30 border border-emerald-900/50 rounded-lg"
              >
                <i
                  data-lucide="shield-check"
                  class="w-4 h-4 text-emerald-500 mt-0.5 flex-shrink-0"
                ></i>
                <p class="text-xs text-emerald-400/90">
                  Your credentials are stored locally in your browser and never
                  sent to any server. All API calls are made directly from your
                  browser to GitHub.
                </p>
              </div>
            </div>

            <div
              x-show="isLocal"
              class="flex items-center gap-3 p-3 bg-zinc-800/50 rounded-xl border border-zinc-700/50"
            >
              <input
                type="checkbox"
                id="useLocalFile"
                x-model="settingsForm.useLocalFile"
                class="w-4 h-4 rounded bg-zinc-700 border-zinc-600 text-accent-600 focus:ring-accent-600 focus:ring-offset-zinc-900"
              />
              <label
                for="useLocalFile"
                class="flex items-center gap-2 text-sm text-zinc-300 cursor-pointer"
              >
                <i data-lucide="file-json" class="w-4 h-4 text-zinc-500"></i>
                Use local data.json file (CLI mode)
              </label>
            </div>

            <div>
              <label class="flex items-center gap-2 text-sm text-zinc-400 mb-2">
                <i data-lucide="palette" class="w-4 h-4"></i>
                Accent Color
              </label>
              <div class="flex flex-wrap gap-2">
                <template x-for="(shades, name) in accentColors" :key="name">
                  <button
                    @click="settingsForm.accentColor = name"
                    :style="{ backgroundColor: shades[500] }"
                    :class="settingsForm.accentColor === name ? 'ring-2 ring-white ring-offset-2 ring-offset-zinc-900' : ''"
                    class="w-8 h-8 rounded-lg transition-all hover:scale-110"
                    :title="name"
                  ></button>
                </template>
              </div>
            </div>
          </div>

          <div class="flex gap-3 mt-6">
            <button
              @click="showSettings = false"
              class="flex-1 inline-flex items-center justify-center gap-2 px-4 py-2.5 text-sm bg-zinc-800 hover:bg-zinc-700 rounded-xl border border-zinc-700 transition-colors"
            >
              Cancel
            </button>
            <button
              @click="saveSettings()"
              class="flex-1 inline-flex items-center justify-center gap-2 px-4 py-2.5 text-sm bg-accent-600 hover:bg-accent-500 text-white rounded-xl transition-colors"
            >
              <i data-lucide="download" class="w-4 h-4"></i>
              Save & Load Data
            </button>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div
        x-show="loading"
        x-cloak
        class="flex flex-col items-center justify-center py-32"
      >
        <div class="relative">
          <div class="w-12 h-12 border-4 border-zinc-800 rounded-full"></div>
          <div
            class="w-12 h-12 border-4 border-accent-500 border-t-transparent rounded-full absolute inset-0 animate-spin"
          ></div>
        </div>
        <p class="text-zinc-500 mt-4">Loading contribution data...</p>
      </div>

      <!-- Error State -->
      <div
        x-show="error"
        x-cloak
        class="flex items-start gap-4 bg-red-950/30 border border-red-900/50 rounded-xl p-5 mb-6"
      >
        <div class="p-2 bg-red-900/30 rounded-lg">
          <i data-lucide="alert-circle" class="w-5 h-5 text-red-400"></i>
        </div>
        <div class="flex-1">
          <p class="text-red-400 font-medium">Error loading data</p>
          <p class="text-red-400/80 text-sm mt-1" x-text="error"></p>
          <button
            @click="error = null; showSettings = true"
            class="inline-flex items-center gap-1 mt-3 text-sm text-red-400 hover:text-red-300 transition-colors"
          >
            <i data-lucide="settings" class="w-4 h-4"></i>
            Check settings
          </button>
        </div>
      </div>

      <!-- Empty State -->
      <div x-show="!loading && !error && !data" class="text-center py-32">
        <div
          class="inline-flex items-center justify-center w-20 h-20 bg-zinc-900 rounded-2xl border border-zinc-800 mb-6"
        >
          <i data-lucide="bar-chart-3" class="w-10 h-10 text-zinc-600"></i>
        </div>
        <h2 class="text-xl font-semibold mb-2">No data loaded</h2>
        <p class="text-zinc-500 mb-6 max-w-sm mx-auto">
          Configure your GitHub credentials to view your contribution activity
        </p>
        <button
          @click="showSettings = true"
          class="inline-flex items-center gap-2 px-6 py-2.5 bg-accent-600 hover:bg-accent-500 rounded-xl transition-colors"
        >
          <i data-lucide="play" class="w-4 h-4"></i>
          Get Started
        </button>
      </div>

      <!-- Dashboard Content -->
      <div x-show="!loading && !error && data" x-cloak class="space-y-6">
        <!-- Stats Overview -->
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
          <div class="bg-zinc-900 border border-zinc-800 rounded-xl p-4">
            <div class="flex items-center gap-2 text-zinc-500 text-sm mb-1">
              <i data-lucide="git-commit" class="w-4 h-4"></i>
              Total Contributions
            </div>
            <div
              class="text-2xl font-semibold"
              x-text="data?.totalContributions?.toLocaleString() || 0"
            ></div>
          </div>
          <div class="bg-zinc-900 border border-zinc-800 rounded-xl p-4">
            <div class="flex items-center gap-2 text-zinc-500 text-sm mb-1">
              <i data-lucide="folder-git-2" class="w-4 h-4"></i>
              Active Repos
            </div>
            <div
              class="text-2xl font-semibold"
              x-text="data?.repos?.length || 0"
            ></div>
          </div>
          <div class="bg-zinc-900 border border-zinc-800 rounded-xl p-4">
            <div class="flex items-center gap-2 text-zinc-500 text-sm mb-1">
              <i data-lucide="flame" class="w-4 h-4"></i>
              Best Day
            </div>
            <div
              class="text-2xl font-semibold"
              x-text="data?.maxCount || 0"
            ></div>
            <div
              class="text-xs text-zinc-500 mt-0.5"
              x-text="data?.bestDay ? formatDate(data.bestDay) : ''"
            ></div>
          </div>
          <div class="bg-zinc-900 border border-zinc-800 rounded-xl p-4">
            <div class="flex items-center gap-2 text-zinc-500 text-sm mb-1">
              <i data-lucide="trending-up" class="w-4 h-4"></i>
              Daily Average
            </div>
            <div
              class="text-2xl font-semibold"
              x-text="data?.dailyAverage?.toFixed(1) || 0"
            ></div>
          </div>
        </div>

        <!-- Heatmap Section -->
        <section class="bg-zinc-900 border border-zinc-800 rounded-xl p-5">
          <div class="flex items-center justify-between mb-4">
            <h3 class="flex items-center gap-2 font-semibold">
              <i data-lucide="calendar-days" class="w-5 h-5 text-zinc-500"></i>
              Contribution Activity
            </h3>
            <div class="flex items-center gap-2 text-xs text-zinc-500">
              <span>Less</span>
              <div class="flex gap-1">
                <div class="w-3 h-3 rounded-sm bg-zinc-800"></div>
                <div class="w-3 h-3 rounded-sm bg-accent-900"></div>
                <div class="w-3 h-3 rounded-sm bg-accent-700"></div>
                <div class="w-3 h-3 rounded-sm bg-accent-500"></div>
                <div class="w-3 h-3 rounded-sm bg-accent-400"></div>
              </div>
              <span>More</span>
            </div>
          </div>

          <div class="overflow-x-auto -mx-2 px-2">
            <div x-html="renderHeatmap()" class="min-w-fit"></div>
          </div>
        </section>

        <!-- Bottom Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Commits by Repo -->
          <section class="bg-zinc-900 border border-zinc-800 rounded-xl p-5">
            <h3 class="flex items-center gap-2 font-semibold mb-4">
              <i
                data-lucide="git-pull-request"
                class="w-5 h-5 text-zinc-500"
              ></i>
              Commits by Repository
            </h3>
            <div x-html="renderBarChart()" class="min-h-[280px]"></div>
          </section>

          <!-- Monthly Activity -->
          <section
            class="bg-zinc-900 border border-zinc-800 rounded-xl p-5 flex flex-col"
          >
            <h3 class="flex items-center gap-2 font-semibold mb-4">
              <i data-lucide="activity" class="w-5 h-5 text-zinc-500"></i>
              Monthly Activity
            </h3>
            <div x-html="renderTrendChart()" class="flex-1 min-h-[200px]"></div>
          </section>
        </div>

        <!-- Activity Log -->
        <section class="bg-zinc-900 border border-zinc-800 rounded-xl p-5">
          <div class="flex items-center justify-between mb-4">
            <h3 class="flex items-center gap-2 font-semibold">
              <i data-lucide="calendar" class="w-5 h-5 text-zinc-500"></i>
              Activity Log
            </h3>
            <div class="flex items-center gap-3">
              <!-- Group Mode Toggle -->
              <div class="flex bg-zinc-800 rounded-lg p-0.5 text-xs">
                <button
                  @click="activityGroupMode = 'daily'"
                  :class="activityGroupMode === 'daily' ? 'bg-zinc-700 text-white' : 'text-zinc-400 hover:text-white'"
                  class="px-2 py-1 rounded transition-colors"
                >
                  Daily
                </button>
                <button
                  @click="activityGroupMode = 'weekly'"
                  :class="activityGroupMode === 'weekly' ? 'bg-zinc-700 text-white' : 'text-zinc-400 hover:text-white'"
                  class="px-2 py-1 rounded transition-colors"
                >
                  Weekly
                </button>
                <button
                  @click="activityGroupMode = 'monthly'"
                  :class="activityGroupMode === 'monthly' ? 'bg-zinc-700 text-white' : 'text-zinc-400 hover:text-white'"
                  class="px-2 py-1 rounded transition-colors"
                >
                  Monthly
                </button>
              </div>
              <!-- Expand/Collapse All Toggle -->
              <button
                @click="toggleAllGroups()"
                class="p-1.5 text-zinc-500 hover:text-zinc-300"
                :title="areAllGroupsExpanded() ? 'Collapse all' : 'Expand all'"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-4 h-4 transition-transform duration-200"
                  :class="areAllGroupsExpanded() ? 'rotate-180' : ''"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="m7 15 5 5 5-5" />
                  <path d="m7 9 5-5 5 5" />
                </svg>
              </button>
            </div>
          </div>
          <div class="space-y-3">
            <template x-for="group in getActivityGroups()" :key="group.key">
              <div class="border border-zinc-800 rounded-lg overflow-hidden">
                <!-- Group Header -->
                <button
                  @click="toggleGroup(group.key)"
                  class="w-full flex items-center justify-between px-4 py-3 bg-zinc-800/50 hover:bg-zinc-800 transition-colors"
                >
                  <div class="flex items-center gap-2">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="w-4 h-4 text-zinc-500 transition-transform"
                      :class="expandedGroups[group.key] ? 'rotate-90' : ''"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path d="m9 18 6-6-6-6" />
                    </svg>
                    <span
                      class="font-medium text-zinc-200"
                      x-text="group.label"
                    ></span>
                  </div>
                  <span class="text-sm text-zinc-500">
                    total:
                    <span class="text-zinc-400" x-text="group.total"></span>
                  </span>
                </button>
                <!-- Items List -->
                <div
                  x-show="expandedGroups[group.key]"
                  x-collapse
                  class="divide-y divide-zinc-800/50"
                >
                  <!-- Daily/Weekly mode: show day rows -->
                  <template x-if="activityGroupMode !== 'monthly'">
                    <template x-for="day in group.items" :key="day.date">
                      <div
                        class="flex items-center justify-between py-2 px-4 hover:bg-zinc-800/30 transition-colors"
                      >
                        <div class="flex items-center gap-3">
                          <div
                            class="w-3 h-3 rounded-full"
                            :class="day.contributionCount === 0 ? 'bg-zinc-700' : day.contributionCount < 5 ? 'bg-accent-700' : 'bg-accent-500'"
                          ></div>
                          <span
                            class="text-sm text-zinc-300"
                            x-text="formatDate(day.date)"
                          ></span>
                          <span
                            class="text-xs text-zinc-600"
                            x-text="getDayOfWeek(day.date)"
                          ></span>
                        </div>
                        <span
                          class="text-sm font-medium"
                          :class="day.contributionCount === 0 ? 'text-zinc-600' : 'text-zinc-300'"
                          x-text="day.contributionCount + ' contribution' + (day.contributionCount !== 1 ? 's' : '')"
                        ></span>
                      </div>
                    </template>
                  </template>
                  <!-- Monthly mode: show month rows -->
                  <template x-if="activityGroupMode === 'monthly'">
                    <template x-for="month in group.items" :key="month.key">
                      <div
                        class="flex items-center justify-between py-2 px-4 hover:bg-zinc-800/30 transition-colors"
                      >
                        <div class="flex items-center gap-3">
                          <div
                            class="w-3 h-3 rounded-full"
                            :class="month.count === 0 ? 'bg-zinc-700' : month.count < 50 ? 'bg-accent-700' : 'bg-accent-500'"
                          ></div>
                          <span
                            class="text-sm text-zinc-300"
                            x-text="month.label"
                          ></span>
                          <span
                            class="text-xs text-zinc-600"
                            x-text="month.days + ' days'"
                          ></span>
                        </div>
                        <span
                          class="text-sm font-medium"
                          :class="month.count === 0 ? 'text-zinc-600' : 'text-zinc-300'"
                          x-text="month.count + ' contribution' + (month.count !== 1 ? 's' : '')"
                        ></span>
                      </div>
                    </template>
                  </template>
                </div>
              </div>
            </template>
          </div>
        </section>
      </div>

      <!-- Footer -->
      <footer
        class="mt-8 pt-6 border-t border-zinc-800 text-center text-xs text-zinc-600"
      >
        <p>Data fetched from GitHub GraphQL API</p>
        <p
          class="mt-1"
          x-show="data?.fetchedAt"
          x-text="'Last updated: ' + formatDateTime(data?.fetchedAt)"
        ></p>
      </footer>
    </div>

    <script>
      // Chart tooltip functions
      function showChartTooltip(event, count, label) {
        const tooltip = document.getElementById("chartTooltip");
        tooltip.querySelector(".chart-tooltip-count").textContent =
          count.toLocaleString();
        tooltip.querySelector(".chart-tooltip-label").textContent = label;

        // Position tooltip above the dot
        const rect = event.target.getBoundingClientRect();
        const tooltipRect = tooltip.getBoundingClientRect();

        let left = rect.left + rect.width / 2 - tooltipRect.width / 2;
        let top = rect.top - tooltipRect.height - 10;

        // Keep tooltip within viewport
        if (left < 10) left = 10;
        if (left + tooltipRect.width > window.innerWidth - 10) {
          left = window.innerWidth - tooltipRect.width - 10;
        }
        if (top < 10) {
          top = rect.bottom + 10; // Show below if not enough space above
        }

        tooltip.style.left = left + "px";
        tooltip.style.top = top + "px";
        tooltip.classList.add("visible");

        // Enlarge the dot
        event.target.setAttribute("r", "7");
        event.target.setAttribute("stroke-width", "3");
      }

      function hideChartTooltip(event) {
        const tooltip = document.getElementById("chartTooltip");
        tooltip.classList.remove("visible");

        // Reset dot size
        event.target.setAttribute("r", "5");
        event.target.setAttribute("stroke-width", "2");
      }

      function dashboard() {
        return {
          username: "",
          token: "",
          useLocalFile: false,
          accentColor: "emerald",
          accentColors: accentColors,
          isLocal:
            location.protocol === "file:" ||
            ["localhost", "127.0.0.1"].includes(location.hostname),
          avatarUrl: "",
          data: null,
          loading: false,
          error: null,
          showSettings: false,
          activityGroupMode: "daily", // 'daily' | 'weekly' | 'monthly'
          expandedGroups: {},
          settingsForm: {
            username: "",
            token: "",
            useLocalFile: false,
            accentColor: "emerald",
          },
          selectedPreset: "1y",
          customDateFrom: null,
          customDateTo: null,
          dateFromPicker: null,
          dateToPickerInstance: null,
          datePresets: [
            { label: "This Week", value: "1w" },
            { label: "This Month", value: "1m" },
            { label: "3 Months", value: "3m" },
            { label: "6 Months", value: "6m" },
            { label: "1 Year", value: "1y" },
            { label: "3 Years", value: "3y" },
          ],

          init() {
            // Initialize Lucide icons
            lucide.createIcons();

            // Initialize date pickers
            this.$nextTick(() => {
              this.initDatePickers();
            });

            // Load from localStorage
            const saved = localStorage.getItem("github-dashboard");
            if (saved) {
              const {
                username,
                token,
                useLocalFile,
                selectedPreset,
                accentColor,
              } = JSON.parse(saved);
              this.username = username || "";
              this.token = token || "";
              this.useLocalFile = useLocalFile || false;
              this.selectedPreset = selectedPreset || "1y";
              this.accentColor = accentColor || "emerald";
              this.settingsForm = {
                username: this.username,
                token: this.token,
                useLocalFile: this.useLocalFile,
                accentColor: this.accentColor,
              };

              if ((this.username && this.token) || this.useLocalFile) {
                this.fetchData();
              }
            }

            // Watch for Alpine updates to reinitialize icons
            this.$watch("data", () => {
              this.$nextTick(() => lucide.createIcons());
            });
            this.$watch("showSettings", () => {
              this.$nextTick(() => lucide.createIcons());
            });
            this.$watch("error", () => {
              this.$nextTick(() => lucide.createIcons());
            });
            // Reset expanded groups when mode changes
            this.$watch("activityGroupMode", () => {
              this.expandedGroups = { [this.getCurrentGroupKey()]: true };
            });
          },

          initDatePickers() {
            const commonConfig = {
              dateFormat: "Y-m-d",
              maxDate: "today",
              disableMobile: true,
            };

            this.dateFromPicker = flatpickr(this.$refs.dateFromInput, {
              ...commonConfig,
              onChange: (dates) => {
                this.customDateFrom = dates[0];
                this.selectedPreset = "custom";
              },
            });

            this.dateToPickerInstance = flatpickr(this.$refs.dateToInput, {
              ...commonConfig,
              onChange: (dates) => {
                this.customDateTo = dates[0];
                this.selectedPreset = "custom";
              },
            });
          },

          getDateRange() {
            const now = new Date();
            let from = new Date();

            switch (this.selectedPreset) {
              case "1w":
                from.setDate(now.getDate() - 7);
                break;
              case "1m":
                from.setMonth(now.getMonth() - 1);
                break;
              case "3m":
                from.setMonth(now.getMonth() - 3);
                break;
              case "6m":
                from.setMonth(now.getMonth() - 6);
                break;
              case "1y":
                from.setFullYear(now.getFullYear() - 1);
                break;
              case "3y":
                from.setFullYear(now.getFullYear() - 3);
                break;
              case "custom":
                if (this.customDateFrom && this.customDateTo) {
                  return { from: this.customDateFrom, to: this.customDateTo };
                }
                from.setFullYear(now.getFullYear() - 1);
                break;
            }

            return { from, to: now };
          },

          selectPreset(preset) {
            this.selectedPreset = preset;
            this.savePreference();
            this.fetchData();
          },

          applyCustomRange() {
            if (this.customDateFrom && this.customDateTo) {
              this.selectedPreset = "custom";
              this.fetchData();
            }
          },

          savePreference() {
            localStorage.setItem(
              "github-dashboard",
              JSON.stringify({
                username: this.username,
                token: this.token,
                useLocalFile: this.useLocalFile,
                selectedPreset: this.selectedPreset,
                accentColor: this.accentColor,
              }),
            );
          },

          async saveSettings() {
            this.username = this.settingsForm.username;
            this.token = this.settingsForm.token;
            this.useLocalFile = this.settingsForm.useLocalFile;
            const colorChanged =
              this.accentColor !== this.settingsForm.accentColor;
            this.accentColor = this.settingsForm.accentColor;

            this.savePreference();
            this.showSettings = false;

            if (colorChanged) {
              location.reload();
            } else {
              await this.fetchData();
            }
          },

          async fetchData() {
            this.loading = true;
            this.error = null;

            try {
              if (this.useLocalFile) {
                await this.fetchFromFile();
              } else {
                await this.fetchFromAPI();
              }
            } catch (err) {
              this.error = err.message;
              this.data = null;
            } finally {
              this.loading = false;
              this.$nextTick(() => lucide.createIcons());
            }
          },

          async fetchFromFile() {
            const response = await fetch("data.json");
            if (!response.ok) {
              throw new Error(
                "Could not load data.json. Run fetch-data.sh first.",
              );
            }
            const json = await response.json();
            this.processData(json);
          },

          async fetchFromAPI() {
            if (!this.username || !this.token) {
              throw new Error("Username and token are required");
            }

            const { from, to } = this.getDateRange();
            const chunks = this.getDateChunks(from, to);

            // Debug logging for date range investigation
            console.log("Date range:", {
              from: from.toISOString(),
              to: to.toISOString(),
            });
            console.log(
              "Chunks:",
              chunks.map((c) => ({
                from: c.from.toISOString(),
                to: c.to.toISOString(),
              })),
            );

            if (chunks.length === 1) {
              // Single chunk - direct fetch
              const json = await this.fetchChunk(chunks[0].from, chunks[0].to);
              this.processData(json);
            } else {
              // Multiple chunks - fetch all and merge
              const results = await Promise.all(
                chunks.map((chunk) => this.fetchChunk(chunk.from, chunk.to)),
              );
              const mergedJson = this.mergeResults(results);
              this.processData(mergedJson);
            }
          },

          getDateChunks(from, to) {
            const chunks = [];
            const msPerDay = 24 * 60 * 60 * 1000;
            const maxDays = 365; // GitHub API limit

            let chunkStart = new Date(from);
            const endDate = new Date(to);

            while (chunkStart < endDate) {
              // Calculate chunk end (max 365 days from start, or end date)
              let chunkEnd = new Date(
                chunkStart.getTime() + maxDays * msPerDay,
              );
              if (chunkEnd > endDate) {
                chunkEnd = endDate;
              }

              chunks.push({
                from: new Date(chunkStart),
                to: new Date(chunkEnd),
              });

              // Move start to next day after chunk end
              chunkStart = new Date(chunkEnd.getTime() + msPerDay);
            }

            return chunks;
          },

          async fetchChunk(from, to) {
            const query = `
                        query($username: String!, $from: DateTime!, $to: DateTime!) {
                            user(login: $username) {
                                avatarUrl
                                contributionsCollection(from: $from, to: $to) {
                                    contributionCalendar {
                                        totalContributions
                                        weeks {
                                            contributionDays {
                                                date
                                                contributionCount
                                            }
                                        }
                                    }
                                    commitContributionsByRepository(maxRepositories: 100) {
                                        repository {
                                            name
                                            nameWithOwner
                                            isPrivate
                                        }
                                        contributions {
                                            totalCount
                                        }
                                    }
                                }
                            }
                        }
                    `;

            const response = await fetch("https://api.github.com/graphql", {
              method: "POST",
              headers: {
                Authorization: `Bearer ${this.token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                query,
                variables: {
                  username: this.username,
                  from: from.toISOString(),
                  to: to.toISOString(),
                },
              }),
            });

            const json = await response.json();

            if (json.errors) {
              throw new Error(json.errors[0].message);
            }

            if (!json.data?.user) {
              throw new Error(`User "${this.username}" not found`);
            }

            return json;
          },

          mergeResults(results) {
            // Use first result as base
            const merged = JSON.parse(JSON.stringify(results[0]));
            const mergedCollection = merged.data.user.contributionsCollection;
            const mergedCalendar = mergedCollection.contributionCalendar;

            // Merge subsequent results
            for (let i = 1; i < results.length; i++) {
              const collection = results[i].data.user.contributionsCollection;
              const calendar = collection.contributionCalendar;

              // Sum total contributions
              mergedCalendar.totalContributions += calendar.totalContributions;

              // Concatenate weeks
              mergedCalendar.weeks = mergedCalendar.weeks.concat(
                calendar.weeks,
              );

              // Merge repository contributions
              const repoMap = new Map();

              // Add existing repos from merged result
              mergedCollection.commitContributionsByRepository.forEach(
                (repo) => {
                  repoMap.set(repo.repository.nameWithOwner, repo);
                },
              );

              // Add/merge repos from current chunk
              collection.commitContributionsByRepository.forEach((repo) => {
                const key = repo.repository.nameWithOwner;
                if (repoMap.has(key)) {
                  // Aggregate commits
                  repoMap.get(key).contributions.totalCount +=
                    repo.contributions.totalCount;
                } else {
                  repoMap.set(key, JSON.parse(JSON.stringify(repo)));
                }
              });

              mergedCollection.commitContributionsByRepository = Array.from(
                repoMap.values(),
              );
            }

            return merged;
          },

          processData(json) {
            // Store avatar URL if available
            if (json.data.user.avatarUrl) {
              this.avatarUrl = json.data.user.avatarUrl;
            }

            const collection = json.data.user.contributionsCollection;
            const calendar = collection.contributionCalendar;

            // Flatten days from weeks
            const days = calendar.weeks.flatMap((w) => w.contributionDays);

            // Get max contribution and best day
            let maxCount = 0;
            let bestDay = null;
            days.forEach((d) => {
              if (d.contributionCount > maxCount) {
                maxCount = d.contributionCount;
                bestDay = d.date;
              }
            });

            // Calculate daily average
            const totalDays = days.length || 1;
            const dailyAverage = calendar.totalContributions / totalDays;

            // Calculate percentiles for color levels
            const nonZeroCounts = days
              .map((d) => d.contributionCount)
              .filter((c) => c > 0)
              .sort((a, b) => a - b);
            const p25 =
              nonZeroCounts[Math.floor(nonZeroCounts.length * 0.25)] || 1;
            const p50 =
              nonZeroCounts[Math.floor(nonZeroCounts.length * 0.5)] || 2;
            const p75 =
              nonZeroCounts[Math.floor(nonZeroCounts.length * 0.75)] || 3;

            // Process repos
            const repos = collection.commitContributionsByRepository
              .map((r) => ({
                name: r.repository.name,
                fullName: r.repository.nameWithOwner,
                isPrivate: r.repository.isPrivate,
                commits: r.contributions.totalCount,
              }))
              .filter((r) => r.commits > 0)
              .sort((a, b) => b.commits - a.commits);

            // Calculate monthly totals
            const monthlyTotals = {};
            days.forEach((d) => {
              const month = d.date.substring(0, 7);
              monthlyTotals[month] =
                (monthlyTotals[month] || 0) + d.contributionCount;
            });

            // Debug logging for monthly totals investigation
            console.log(
              "Monthly totals months:",
              Object.keys(monthlyTotals).sort(),
            );

            // All days sorted newest first for activity log
            const activityDays = [...days].reverse();

            this.data = {
              totalContributions: calendar.totalContributions,
              weeks: calendar.weeks,
              days,
              maxCount,
              bestDay,
              dailyAverage,
              percentiles: { p25, p50, p75 },
              repos,
              monthlyTotals,
              activityDays,
              fetchedAt: new Date().toISOString(),
            };

            // Initialize expandedGroups with current period expanded
            this.expandedGroups = { [this.getCurrentGroupKey()]: true };
          },

          formatDate(dateStr) {
            const date = new Date(dateStr + "T00:00:00");
            return date.toLocaleDateString("en-US", {
              month: "short",
              day: "numeric",
              year: "numeric",
            });
          },

          formatDateTime(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString("en-US", {
              month: "short",
              day: "numeric",
              year: "numeric",
              hour: "2-digit",
              minute: "2-digit",
            });
          },

          getDayOfWeek(dateStr) {
            const date = new Date(dateStr + "T00:00:00");
            return date.toLocaleDateString("en-US", { weekday: "short" });
          },

          getCurrentMonthKey() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}`;
          },

          getCurrentWeekKey() {
            const now = new Date();
            const weekNum = this.getWeekNumber(now);
            return `${now.getFullYear()}-W${String(weekNum).padStart(2, "0")}`;
          },

          getCurrentYearKey() {
            return String(new Date().getFullYear());
          },

          getCurrentGroupKey() {
            switch (this.activityGroupMode) {
              case "weekly":
                return this.getCurrentWeekKey();
              case "monthly":
                return this.getCurrentYearKey();
              default:
                return this.getCurrentMonthKey();
            }
          },

          groupDaysByMonth() {
            if (!this.data?.activityDays) return [];

            const groups = {};
            this.data.activityDays.forEach((day) => {
              const monthKey = day.date.substring(0, 7);
              if (!groups[monthKey]) {
                const date = new Date(monthKey + "-01");
                groups[monthKey] = {
                  key: monthKey,
                  label: date.toLocaleDateString("en-US", {
                    month: "long",
                    year: "numeric",
                  }),
                  items: [],
                  total: 0,
                };
              }
              groups[monthKey].items.push(day);
              groups[monthKey].total += day.contributionCount;
            });

            return Object.values(groups).sort((a, b) =>
              b.key.localeCompare(a.key),
            );
          },

          // Main dispatcher based on mode
          getActivityGroups() {
            switch (this.activityGroupMode) {
              case "weekly":
                return this.groupDaysByWeek();
              case "monthly":
                return this.groupMonthsByYear();
              default:
                return this.groupDaysByMonth();
            }
          },

          // Weekly grouped by year
          groupDaysByWeek() {
            if (!this.data?.activityDays) return [];
            const groups = {};
            this.data.activityDays.forEach((day) => {
              const date = new Date(day.date + "T00:00:00");
              const year = date.getFullYear();
              const weekNum = this.getWeekNumber(date);
              const weekKey = `${year}-W${String(weekNum).padStart(2, "0")}`;
              if (!groups[weekKey]) {
                groups[weekKey] = {
                  key: weekKey,
                  label: `Week ${weekNum}, ${year}`,
                  items: [],
                  total: 0,
                };
              }
              groups[weekKey].items.push(day);
              groups[weekKey].total += day.contributionCount;
            });
            return Object.values(groups).sort((a, b) =>
              b.key.localeCompare(a.key),
            );
          },

          // Monthly grouped by year
          groupMonthsByYear() {
            if (!this.data?.activityDays) return [];
            // First aggregate by month
            const monthTotals = {};
            this.data.activityDays.forEach((day) => {
              const monthKey = day.date.substring(0, 7);
              if (!monthTotals[monthKey]) {
                monthTotals[monthKey] = { count: 0, days: 0 };
              }
              monthTotals[monthKey].count += day.contributionCount;
              monthTotals[monthKey].days++;
            });
            // Then group by year
            const groups = {};
            Object.entries(monthTotals).forEach(([monthKey, data]) => {
              const year = monthKey.substring(0, 4);
              if (!groups[year]) {
                groups[year] = { key: year, label: year, items: [], total: 0 };
              }
              const date = new Date(monthKey + "-01");
              groups[year].items.push({
                key: monthKey,
                label: date.toLocaleDateString("en-US", { month: "long" }),
                count: data.count,
                days: data.days,
              });
              groups[year].total += data.count;
            });
            // Sort months within each year (newest first)
            Object.values(groups).forEach((g) =>
              g.items.sort((a, b) => b.key.localeCompare(a.key)),
            );
            return Object.values(groups).sort((a, b) =>
              b.key.localeCompare(a.key),
            );
          },

          getWeekNumber(date) {
            const d = new Date(
              Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()),
            );
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil(((d - yearStart) / 86400000 + 1) / 7);
          },

          areAllGroupsExpanded() {
            const groups = this.getActivityGroups();
            if (groups.length === 0) return false;
            return groups.every((g) => this.expandedGroups[g.key]);
          },

          toggleAllGroups() {
            const groups = this.getActivityGroups();
            if (this.areAllGroupsExpanded()) {
              // Collapse all - set each key to false for reactivity
              groups.forEach((g) => (this.expandedGroups[g.key] = false));
            } else {
              // Expand all
              groups.forEach((g) => (this.expandedGroups[g.key] = true));
            }
          },

          toggleGroup(key) {
            this.expandedGroups[key] = !this.expandedGroups[key];
          },

          getColorLevel(count) {
            if (count === 0) return 0;
            const { p25, p50, p75 } = this.data.percentiles;
            if (count <= p25) return 1;
            if (count <= p50) return 2;
            if (count <= p75) return 3;
            return 4;
          },

          getColorClass(level) {
            const accent =
              this.accentColors[this.accentColor] || this.accentColors.emerald;
            const colors = [
              "#27272a", // zinc-800
              accent[900],
              accent[700],
              accent[500],
              accent[400],
            ];
            return colors[level];
          },

          renderHeatmap() {
            if (!this.data) return "";

            const cellSize = 11;
            const cellGap = 3;
            const yearGap = 20;
            const weeks = this.data.weeks;
            const months = [
              "Jan",
              "Feb",
              "Mar",
              "Apr",
              "May",
              "Jun",
              "Jul",
              "Aug",
              "Sep",
              "Oct",
              "Nov",
              "Dec",
            ];

            // First pass: calculate x positions with year gaps
            const weekPositions = [];
            let lastYear = -1;
            let x = 50;
            const yearBoundaries = []; // Track where year labels should go

            weeks.forEach((week, weekIndex) => {
              if (week.contributionDays.length > 0) {
                const date = new Date(week.contributionDays[0].date);
                const year = date.getFullYear();

                if (lastYear !== -1 && year !== lastYear) {
                  // Add gap before new year
                  x += yearGap;
                }

                if (year !== lastYear) {
                  yearBoundaries.push({ x, year });
                  lastYear = year;
                }
              }

              weekPositions.push(x);
              x += cellSize + cellGap;
            });

            const width = x + 10;
            const height = 7 * (cellSize + cellGap) + 40; // Extra height for year labels

            // Year labels (at top)
            let yearLabels = yearBoundaries
              .map(
                ({ x, year }) =>
                  `<text x="${x}" y="10" fill="#a1a1aa" style="font-size: 12px; font-weight: 500; font-family: system-ui, sans-serif">${year}</text>`,
              )
              .join("");

            // Month labels (below year labels)
            let monthLabels = "";
            let lastMonth = -1;

            weeks.forEach((week, weekIndex) => {
              if (week.contributionDays.length > 0) {
                const date = new Date(week.contributionDays[0].date);
                const month = date.getMonth();
                if (month !== lastMonth) {
                  monthLabels += `<text x="${weekPositions[weekIndex]}" y="24" fill="#71717a" style="font-size: 11px; font-family: system-ui, sans-serif">${months[month]}</text>`;
                  lastMonth = month;
                }
              }
            });

            // Day labels
            const dayLabels = ["", "Mon", "", "Wed", "", "Fri", ""];
            let dayLabelsSvg = dayLabels
              .map(
                (label, i) =>
                  `<text x="0" y="${34 + i * (cellSize + cellGap) + cellSize - 2}" fill="#71717a" style="font-size: 11px; font-family: system-ui, sans-serif">${label}</text>`,
              )
              .join("");

            // Cells
            let cells = "";
            weeks.forEach((week, weekIndex) => {
              week.contributionDays.forEach((day, dayIndex) => {
                const cellX = weekPositions[weekIndex];
                const cellY = 30 + dayIndex * (cellSize + cellGap);
                const level = this.getColorLevel(day.contributionCount);
                const color = this.getColorClass(level);
                const dateStr = this.formatDate(day.date);
                const dayOfWeek = this.getDayOfWeek(day.date);
                const tooltip = `${day.contributionCount} contribution${day.contributionCount !== 1 ? "s" : ""} on ${dayOfWeek}, ${dateStr}`;

                cells += `<rect
                                x="${cellX}"
                                y="${cellY}"
                                width="${cellSize}"
                                height="${cellSize}"
                                rx="2"
                                fill="${color}"
                                style="cursor: pointer; transition: opacity 0.15s"
                                onmouseover="this.style.opacity='0.8'"
                                onmouseout="this.style.opacity='1'"
                            >
                                <title>${tooltip}</title>
                            </rect>`;
              });
            });

            return `<svg width="${width}" height="${height}" style="overflow: visible">
                        ${yearLabels}
                        ${monthLabels}
                        ${dayLabelsSvg}
                        ${cells}
                    </svg>`;
          },

          renderBarChart() {
            if (!this.data || !this.data.repos.length) {
              return `<div class="flex flex-col items-center justify-center h-64 text-zinc-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mb-3 opacity-50"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>
                            <p class="text-sm">No repository data available</p>
                        </div>`;
            }

            const repos = this.data.repos.slice(0, 10);
            const maxCommits = repos[0].commits;
            const barHeight = 24;
            const gap = 8;
            const height = repos.length * (barHeight + gap) + 8;

            let bars = repos
              .map((repo, i) => {
                const y = i * (barHeight + gap) + 4;
                const barWidth = Math.max(4, (repo.commits / maxCommits) * 100);
                const privateIcon = repo.isPrivate
                  ? `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#71717a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" x="130" y="${y + 6}"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>`
                  : "";

                const accentColor =
                  this.accentColors[this.accentColor]?.[500] || "#10b981";
                return `
                            <g>
                                <text x="0" y="${y + barHeight / 2 + 5}" fill="#d4d4d8" style="font-size: 13px; font-family: system-ui, sans-serif">
                                    ${repo.name.length > 18 ? repo.name.substring(0, 18) + "â€¦" : repo.name}
                                </text>
                                ${privateIcon}
                                <rect x="150" y="${y}" width="${barWidth}%" height="${barHeight}" rx="4" fill="${accentColor}" opacity="0.8">
                                    <title>${repo.fullName}: ${repo.commits} commits</title>
                                </rect>
                                <text x="155" y="${y + barHeight / 2 + 5}" fill="#fff" style="font-size: 12px; font-weight: 500; font-family: system-ui, sans-serif">${repo.commits}</text>
                            </g>
                        `;
              })
              .join("");

            return `<svg width="100%" height="${height}" viewBox="0 0 380 ${height}" preserveAspectRatio="xMinYMin meet">
                        ${bars}
                    </svg>`;
          },

          renderTrendChart() {
            if (!this.data || !Object.keys(this.data.monthlyTotals).length) {
              return `<div class="flex flex-col items-center justify-center h-64 text-zinc-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mb-3 opacity-50"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                            <p class="text-sm">No monthly data available</p>
                        </div>`;
            }

            const months = Object.entries(this.data.monthlyTotals).sort(
              ([a], [b]) => a.localeCompare(b),
            );

            if (months.length < 2) {
              // Need at least 2 points for a line
              const [month, count] = months[0];
              const date = new Date(month + "-01");
              const monthName = date.toLocaleDateString("en-US", {
                month: "long",
                year: "numeric",
              });
              return `<div class="flex flex-col items-center justify-center h-64 text-zinc-400">
                            <p class="text-3xl font-semibold text-zinc-200">${count}</p>
                            <p class="text-sm mt-1">contributions in ${monthName}</p>
                        </div>`;
            }

            const values = months.map(([, v]) => v);
            const maxVal = Math.max(...values);

            const width = 500;
            const height = 220;
            const padding = { top: 30, right: 20, bottom: 60, left: 50 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;

            // Create points
            const points = months.map(([month, count], i) => {
              const x =
                padding.left +
                (i / Math.max(1, months.length - 1)) * chartWidth;
              const y =
                padding.top +
                chartHeight -
                (count / (maxVal || 1)) * chartHeight;
              return { x, y, month, count };
            });

            // Area path
            const areaPath =
              `M ${points[0].x} ${padding.top + chartHeight} ` +
              points.map((p) => `L ${p.x} ${p.y}`).join(" ") +
              ` L ${points[points.length - 1].x} ${padding.top + chartHeight} Z`;

            // Line path
            const linePath = points
              .map((p, i) => `${i === 0 ? "M" : "L"} ${p.x} ${p.y}`)
              .join(" ");

            // X-axis labels - two row system
            const monthNames = [
              "Jan",
              "Feb",
              "Mar",
              "Apr",
              "May",
              "Jun",
              "Jul",
              "Aug",
              "Sep",
              "Oct",
              "Nov",
              "Dec",
            ];

            // Row 1: Year labels (above) - show at January or first point
            const yearLabels = points
              .map((p, i) => {
                const [year, monthNum] = months[i][0].split("-");
                // Show year on January or first data point
                const isJanuary = parseInt(monthNum) === 1;
                const isFirst = i === 0;
                if (!isJanuary && !isFirst) return "";

                return `<text x="${p.x}" y="${height - 38}" fill="#a1a1aa" style="font-size: 10px; font-family: system-ui, sans-serif" text-anchor="middle">${year}</text>`;
              })
              .join("");

            // Row 2: Month labels (below) - all months, rotated
            const xLabels = points
              .map((p, i) => {
                const [, monthNum] = months[i][0].split("-");
                const monthLabel = monthNames[parseInt(monthNum) - 1];

                return `<text x="${p.x}" y="${height - 18}" fill="#71717a" style="font-size: 8px; font-family: system-ui, sans-serif" text-anchor="end" transform="rotate(-45, ${p.x}, ${height - 18})">${monthLabel}</text>`;
              })
              .join("");

            // Y-axis labels
            const yTicks = [0, 0.25, 0.5, 0.75, 1];
            const yLabels = yTicks
              .map((ratio) => {
                const val = Math.round(maxVal * ratio);
                const y = padding.top + chartHeight * (1 - ratio);
                return `
                            <text x="${padding.left - 8}" y="${y + 4}" fill="#71717a" style="font-size: 11px; font-family: system-ui, sans-serif" text-anchor="end">${val}</text>
                            <line x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}" stroke="#3f3f46" stroke-dasharray="2,4" opacity="0.5"/>
                        `;
              })
              .join("");

            // Dots with tooltips
            const accentColor =
              this.accentColors[this.accentColor]?.[500] || "#10b981";
            const dots = points
              .map((p) => {
                const date = new Date(p.month + "-01");
                const monthName = date.toLocaleDateString("en-US", {
                  month: "long",
                  year: "numeric",
                });
                return `
                            <circle cx="${p.x}" cy="${p.y}" r="5" fill="#18181b" stroke="${accentColor}" stroke-width="2"
                                style="cursor: pointer; transition: r 0.15s, stroke-width 0.15s"
                                onmouseenter="showChartTooltip(event, ${p.count}, '${monthName}')"
                                onmouseleave="hideChartTooltip(event)"
                            />
                        `;
              })
              .join("");

            return `<svg width="100%" height="100%" viewBox="0 0 ${width} ${height}" preserveAspectRatio="xMidYMid meet">
                        <defs>
                            <linearGradient id="areaGradient" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="0%" stop-color="${accentColor}" stop-opacity="0.3"/>
                                <stop offset="100%" stop-color="${accentColor}" stop-opacity="0.02"/>
                            </linearGradient>
                        </defs>
                        ${yLabels}
                        <path d="${areaPath}" fill="url(#areaGradient)"/>
                        <path d="${linePath}" fill="none" stroke="${accentColor}" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                        ${dots}
                        ${yearLabels}
                        ${xLabels}
                    </svg>`;
          },
        };
      }

      // Register service worker for PWA
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("/app/sw.js").catch(() => {});
      }
    </script>
  </body>
</html>
